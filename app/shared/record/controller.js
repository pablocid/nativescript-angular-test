"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var lodash_1 = require("lodash");
var _1 = require("./");
var RecordController = (function () {
    function RecordController(collection) {
        // if (
        //     collection &&
        //     collection === 'espaldera' ||
        //     collection === 'records' ||
        //     collection === 'plantas'
        // ) {
        // }
        this._dbPlants = _1.Collection.getCollection('espaldera');
        this._dbSchm = _1.Collection.getCollection('schema');
    }
    RecordController.prototype.getPlant = function (_id) {
        var _this = this;
        return this._dbPlants
            .then(function (db) {
            return db.findOne({ _id: _id });
        })
            .then(function (x) {
            return _this._getSchema(x.schm)
                .then(function (z) {
                return { schema: z.schema, attrs: z.attrSchms, raw: x };
            });
        })
            .then(function (x) { return _this._setPlant(x.schema, x.attrs, x.raw); });
    };
    RecordController.prototype._setPlant = function (schema, attrSchms, raw) {
        var r = new _1.Plant();
        if (!raw)
            return r;
        var keys = Object.keys(raw);
        if (keys.indexOf('_id') === -1 ||
            keys.indexOf('schm') === -1 ||
            keys.indexOf('created') === -1 ||
            keys.indexOf('updated') === -1 ||
            keys.indexOf('updated') === -1) {
            console.log(' El raw object no tiene alguna de estas keys ["_id", "schm", "attributes", "updated", "created"]');
            return r;
        }
        r.id = raw._id;
        r.schema = schema;
        r.setCreateISOString(raw.created);
        r.setUpdated(raw.updated);
        r.attributes = attrSchms
            .map(function (a) { return new _1.Attribute(a, lodash_1.find(raw.attributes, { id: a.id }), r.reference); });
        return r;
    };
    RecordController.prototype._getSchema = function (_id) {
        return this._dbSchm
            .then(function (db) {
            var schema = new _1.Schema(db.findOne({ _id: _id }));
            var listAttr = schema.getAttr('attributes', 'list');
            if (!listAttr || !Array.isArray(listAttr) || !listAttr.length)
                return { schema: schema, attrSchms: [] };
            var attrSchms = listAttr.map(function (x) { return db.findOne({ _id: x }); })
                .filter(function (x) { return x.type === 'attribute'; })
                .map(function (x) { return new _1.AttributeSchm(x); })
                .map(function (x) {
                var i = x.getAttr('input', 'reference');
                x.input = new _1.InputSchm(db.findOne({ _id: i }));
                return x;
            });
            return { schema: schema, attrSchms: attrSchms };
        });
    };
    RecordController.prototype._getSchm = function (_id, db, raw) {
        var schema = new _1.Schema(db.findOne({ _id: _id }));
        var listAttr = schema.getAttr('attributes', 'list');
        if (!listAttr || !Array.isArray(listAttr) || !listAttr.length)
            return { schema: schema, attrSchms: [], raw: raw };
        var attrSchms = listAttr.map(function (x) { return db.findOne({ _id: x }); })
            .filter(function (x) { return x.type === 'attribute'; })
            .map(function (x) { return new _1.AttributeSchm(x); })
            .map(function (x) {
            var i = x.getAttr('input', 'reference');
            x.input = new _1.InputSchm(db.findOne({ _id: i }));
            return x;
        });
        return { schema: schema, attrSchms: attrSchms, raw: raw };
    };
    RecordController.prototype.getRow = function (espaldera, hilera) {
        var _this = this;
        return this._dbPlants
            .then(function (db) {
            return _this._dbSchm.then(function (x) {
                return { dbPlants: db, dbSchm: x };
            });
        })
            .then(function (dbs) {
            return {
                plants: dbs.dbPlants.find({ schm: '57a4e02ec830e2bdff1a1608' })
                    .filter(function (x) {
                    return x.attributes.some(function (x) { return x.id === '5807af5f31f55d0010aaffe4' && x.number === espaldera; }) &&
                        x.attributes.some(function (x) { return x.id === '5807af9231f55d0010aaffe5' && x.number === hilera; });
                }), dbSchm: dbs.dbSchm
            };
        })
            .then(function (dbs) { return dbs.plants.map(function (x) { return _this._getSchm(x.schm, dbs.dbSchm, x); }); })
            .then(function (p) { return p.map(function (x) { return _this._setPlant(x.schema, x.attrSchms, x.raw); }); });
    };
    return RecordController;
}());
exports.RecordController = RecordController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxpQ0FBc0M7QUFDdEMsdUJBQTRGO0FBRTVGO0lBSUksMEJBQVksVUFBbUI7UUFDM0IsT0FBTztRQUNQLG9CQUFvQjtRQUNwQixvQ0FBb0M7UUFDcEMsa0NBQWtDO1FBQ2xDLCtCQUErQjtRQUMvQixNQUFNO1FBRU4sSUFBSTtRQUNKLElBQUksQ0FBQyxTQUFTLEdBQUcsYUFBVSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsT0FBTyxHQUFHLGFBQVUsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVNLG1DQUFRLEdBQWYsVUFBZ0IsR0FBVztRQUEzQixpQkFZQztRQVhHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUzthQUNoQixJQUFJLENBQUMsVUFBQSxFQUFFO1lBQ0osTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxHQUFHLEtBQUEsRUFBRSxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLFVBQUEsQ0FBQztZQUNILE1BQU0sQ0FBQyxLQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7aUJBQ3pCLElBQUksQ0FBQyxVQUFDLENBQUM7Z0JBQ0osTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQzVELENBQUMsQ0FBQyxDQUFBO1FBQ1YsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsS0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEdB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QyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsRUFBRSxLQUFLLDBCQUEwQixJQUFJLENBQUMsQ0FBQyxNQUFNLEtBQUssTUFBTSxFQUExRCxDQUEwRCxDQUFDO2dCQURsRixDQUNrRixDQUNyRixFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTthQUM1QixDQUFBO1FBQ0wsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxLQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBcEMsQ0FBb0MsQ0FBQyxFQUF6RCxDQUF5RCxDQUFDO2FBQ3RFLElBQUksQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxLQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQTVDLENBQTRDLENBQUMsRUFBeEQsQ0FBd0QsQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFFTCx1QkFBQztBQUFELENBQUMsQUFsSEQsSUFrSEM7QUFsSFksNENBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUSBmcm9tICdxJztcbmltcG9ydCB7IGZpbmQgYXMgRmluZCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBDb2xsZWN0aW9uLCBSZWNvcmQsIFNjaGVtYSwgQXR0cmlidXRlU2NobSwgQXR0cmlidXRlLCBJbnB1dFNjaG0sIFBsYW50IH0gZnJvbSAnLi8nO1xuaW1wb3J0IHsgTG9raUNvbGxlY3Rpb24gfSBmcm9tICcuLi9kYl9sb2NhbCc7XG5leHBvcnQgY2xhc3MgUmVjb3JkQ29udHJvbGxlciB7XG4gICAgcHJpdmF0ZSBfZGJTY2htOiBQcm9taXNlPExva2lDb2xsZWN0aW9uPjtcbiAgICBwcml2YXRlIF9kYlBsYW50czogUHJvbWlzZTxMb2tpQ29sbGVjdGlvbj47XG5cbiAgICBjb25zdHJ1Y3Rvcihjb2xsZWN0aW9uPzogc3RyaW5nKSB7XG4gICAgICAgIC8vIGlmIChcbiAgICAgICAgLy8gICAgIGNvbGxlY3Rpb24gJiZcbiAgICAgICAgLy8gICAgIGNvbGxlY3Rpb24gPT09ICdlc3BhbGRlcmEnIHx8XG4gICAgICAgIC8vICAgICBjb2xsZWN0aW9uID09PSAncmVjb3JkcycgfHxcbiAgICAgICAgLy8gICAgIGNvbGxlY3Rpb24gPT09ICdwbGFudGFzJ1xuICAgICAgICAvLyApIHtcblxuICAgICAgICAvLyB9XG4gICAgICAgIHRoaXMuX2RiUGxhbnRzID0gQ29sbGVjdGlvbi5nZXRDb2xsZWN0aW9uKCdlc3BhbGRlcmEnKTtcbiAgICAgICAgdGhpcy5fZGJTY2htID0gQ29sbGVjdGlvbi5nZXRDb2xsZWN0aW9uKCdzY2hlbWEnKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UGxhbnQoX2lkOiBzdHJpbmcpOiBQcm9taXNlPFBsYW50PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kYlBsYW50c1xuICAgICAgICAgICAgLnRoZW4oZGIgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBkYi5maW5kT25lKHsgX2lkIH0pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKHggPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRTY2hlbWEoeC5zY2htKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoeikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgc2NoZW1hOiB6LnNjaGVtYSwgYXR0cnM6IHouYXR0clNjaG1zLCByYXc6IHggfTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbih4ID0+IHRoaXMuX3NldFBsYW50KHguc2NoZW1hLCB4LmF0dHJzLCB4LnJhdykpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3NldFBsYW50KHNjaGVtYTogU2NoZW1hLCBhdHRyU2NobXM6IEF0dHJpYnV0ZVNjaG1bXSwgcmF3OiBhbnkpOiBQbGFudCB7XG4gICAgICAgIGxldCByID0gbmV3IFBsYW50KCk7XG4gICAgICAgIGlmICghcmF3KSByZXR1cm4gcjtcblxuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocmF3KTtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAga2V5cy5pbmRleE9mKCdfaWQnKSA9PT0gLTEgfHxcbiAgICAgICAgICAgIGtleXMuaW5kZXhPZignc2NobScpID09PSAtMSB8fFxuICAgICAgICAgICAga2V5cy5pbmRleE9mKCdjcmVhdGVkJykgPT09IC0xIHx8XG4gICAgICAgICAgICBrZXlzLmluZGV4T2YoJ3VwZGF0ZWQnKSA9PT0gLTEgfHxcbiAgICAgICAgICAgIGtleXMuaW5kZXhPZigndXBkYXRlZCcpID09PSAtMVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCcgRWwgcmF3IG9iamVjdCBubyB0aWVuZSBhbGd1bmEgZGUgZXN0YXMga2V5cyBbXCJfaWRcIiwgXCJzY2htXCIsIFwiYXR0cmlidXRlc1wiLCBcInVwZGF0ZWRcIiwgXCJjcmVhdGVkXCJdJyk7XG4gICAgICAgICAgICByZXR1cm4gcjtcbiAgICAgICAgfVxuXG4gICAgICAgIHIuaWQgPSByYXcuX2lkO1xuICAgICAgICByLnNjaGVtYSA9IHNjaGVtYTtcbiAgICAgICAgci5zZXRDcmVhdGVJU09TdHJpbmcocmF3LmNyZWF0ZWQpO1xuICAgICAgICByLnNldFVwZGF0ZWQocmF3LnVwZGF0ZWQpO1xuICAgICAgICByLmF0dHJpYnV0ZXMgPSBhdHRyU2NobXNcbiAgICAgICAgICAgIC5tYXAoYSA9PiBuZXcgQXR0cmlidXRlKGEsIEZpbmQocmF3LmF0dHJpYnV0ZXMsIHsgaWQ6IGEuaWQgfSksIHIucmVmZXJlbmNlKSk7XG4gICAgICAgIHJldHVybiByO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0U2NoZW1hKF9pZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kYlNjaG1cbiAgICAgICAgICAgIC50aGVuKGRiID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzY2hlbWEgPSBuZXcgU2NoZW1hKGRiLmZpbmRPbmUoeyBfaWQgfSkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGxpc3RBdHRyOiBzdHJpbmdbXSA9IHNjaGVtYS5nZXRBdHRyKCdhdHRyaWJ1dGVzJywgJ2xpc3QnKTtcbiAgICAgICAgICAgICAgICBpZiAoIWxpc3RBdHRyIHx8ICFBcnJheS5pc0FycmF5KGxpc3RBdHRyKSB8fCAhbGlzdEF0dHIubGVuZ3RoKSByZXR1cm4geyBzY2hlbWEsIGF0dHJTY2htczogW10gfTtcblxuICAgICAgICAgICAgICAgIGxldCBhdHRyU2NobXM6IEF0dHJpYnV0ZVNjaG1bXSA9IGxpc3RBdHRyLm1hcCh4ID0+IGRiLmZpbmRPbmUoeyBfaWQ6IHggfSkpXG4gICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoeCA9PiB4LnR5cGUgPT09ICdhdHRyaWJ1dGUnKVxuICAgICAgICAgICAgICAgICAgICAubWFwKHggPT4gbmV3IEF0dHJpYnV0ZVNjaG0oeCkpXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoeCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpID0geC5nZXRBdHRyKCdpbnB1dCcsICdyZWZlcmVuY2UnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHguaW5wdXQgPSBuZXcgSW5wdXRTY2htKGRiLmZpbmRPbmUoeyBfaWQ6IGkgfSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHg7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc2NoZW1hLCBhdHRyU2NobXMgfTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFNjaG0oX2lkOiBzdHJpbmcsIGRiLCByYXc6IGFueSk6IHsgc2NoZW1hOiBTY2hlbWEsIGF0dHJTY2htczogQXR0cmlidXRlU2NobVtdLCByYXc6IGFueSB9IHtcbiAgICAgICAgY29uc3Qgc2NoZW1hID0gbmV3IFNjaGVtYShkYi5maW5kT25lKHsgX2lkIH0pKTtcbiAgICAgICAgY29uc3QgbGlzdEF0dHI6IHN0cmluZ1tdID0gc2NoZW1hLmdldEF0dHIoJ2F0dHJpYnV0ZXMnLCAnbGlzdCcpO1xuICAgICAgICBpZiAoIWxpc3RBdHRyIHx8ICFBcnJheS5pc0FycmF5KGxpc3RBdHRyKSB8fCAhbGlzdEF0dHIubGVuZ3RoKSByZXR1cm4geyBzY2hlbWEsIGF0dHJTY2htczogW10sIHJhdyB9O1xuXG4gICAgICAgIGxldCBhdHRyU2NobXM6IEF0dHJpYnV0ZVNjaG1bXSA9IGxpc3RBdHRyLm1hcCh4ID0+IGRiLmZpbmRPbmUoeyBfaWQ6IHggfSkpXG4gICAgICAgICAgICAuZmlsdGVyKHggPT4geC50eXBlID09PSAnYXR0cmlidXRlJylcbiAgICAgICAgICAgIC5tYXAoeCA9PiBuZXcgQXR0cmlidXRlU2NobSh4KSlcbiAgICAgICAgICAgIC5tYXAoeCA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaSA9IHguZ2V0QXR0cignaW5wdXQnLCAncmVmZXJlbmNlJyk7XG4gICAgICAgICAgICAgICAgeC5pbnB1dCA9IG5ldyBJbnB1dFNjaG0oZGIuZmluZE9uZSh7IF9pZDogaSB9KSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHg7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4geyBzY2hlbWEsIGF0dHJTY2htcywgcmF3IH07XG4gICAgfVxuXG4gICAgcHVibGljIGdldFJvdyhlc3BhbGRlcmE6IG51bWJlciwgaGlsZXJhOiBudW1iZXIpOiBQcm9taXNlPFBsYW50W10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RiUGxhbnRzXG4gICAgICAgICAgICAudGhlbihkYiA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2RiU2NobS50aGVuKHggPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBkYlBsYW50czogZGIsIGRiU2NobTogeCB9O1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oZGJzID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBwbGFudHM6IGRicy5kYlBsYW50cy5maW5kKHsgc2NobTogJzU3YTRlMDJlYzgzMGUyYmRmZjFhMTYwOCcgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoeCA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHguYXR0cmlidXRlcy5zb21lKHggPT4geC5pZCA9PT0gJzU4MDdhZjVmMzFmNTVkMDAxMGFhZmZlNCcgJiYgeC5udW1iZXIgPT09IGVzcGFsZGVyYSkgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4LmF0dHJpYnV0ZXMuc29tZSh4ID0+IHguaWQgPT09ICc1ODA3YWY5MjMxZjU1ZDAwMTBhYWZmZTUnICYmIHgubnVtYmVyID09PSBoaWxlcmEpXG4gICAgICAgICAgICAgICAgICAgICAgICApLCBkYlNjaG06IGRicy5kYlNjaG1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oZGJzID0+IGRicy5wbGFudHMubWFwKHggPT4gdGhpcy5fZ2V0U2NobSh4LnNjaG0sIGRicy5kYlNjaG0sIHgpKSlcbiAgICAgICAgICAgIC50aGVuKHAgPT4gcC5tYXAoeCA9PiB0aGlzLl9zZXRQbGFudCh4LnNjaGVtYSwgeC5hdHRyU2NobXMsIHgucmF3KSkpO1xuICAgIH1cblxufVxuIl19